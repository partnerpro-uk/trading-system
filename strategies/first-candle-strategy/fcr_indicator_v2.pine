// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Essa / Based on caspersmcwisdom's First Candle Rule

//@version=6
indicator("First Candle Rule (FCR)", overlay=true, max_boxes_count=100, max_lines_count=100, max_labels_count=100)

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// SETTINGS
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

sessionStart = input.session("0930-0935", "FCR Session (Market Open)", group="Setup")
sessionTimezone = input.string("America/New_York", "Timezone", options=["America/New_York", "America/Chicago", "America/Los_Angeles", "Europe/London", "UTC"], group="Setup")

showFCRBox = input.bool(true, "Show FCR Candle Box", group="Visuals")
showFCRLines = input.bool(true, "Show FCR High/Low Lines", group="Visuals")
showFVG = input.bool(true, "Show Fair Value Gaps", group="Visuals")
showSignals = input.bool(true, "Show Entry Signals", group="Visuals")
showPosition = input.bool(true, "Show TP/SL Zones", group="Visuals")
showHistoryTable = input.bool(true, "Show History Table", group="Visuals")

rrRatio = input.float(3.0, "Risk:Reward Ratio", minval=1.0, maxval=10.0, step=0.5, group="Strategy")

fcrBoxColor = input.color(color.new(color.blue, 85), "FCR Box Color", group="Colors")
fcrLineColor = input.color(color.new(color.blue, 30), "FCR Line Color", group="Colors")
bullFVGColor = input.color(color.new(color.gray, 75), "Bullish FVG Color", group="Colors")
bearFVGColor = input.color(color.new(color.gray, 75), "Bearish FVG Color", group="Colors")

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// HISTORY TRACKING ARRAYS
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var int[] histDirection = array.new<int>()       // 1 = long, -1 = short
var float[] histEntry = array.new<float>()       // entry price
var float[] histTP = array.new<float>()          // take profit price
var float[] histSL = array.new<float>()          // stop loss price
var string[] histResult = array.new<string>()    // "TP", "SL", "OPEN"
var float[] histPnL = array.new<float>()         // P&L in price units
var int[] histEntryBar = array.new<int>()        // bar index of entry
var int[] histExitBar = array.new<int>()         // bar index of exit

const int MAX_HISTORY = 10

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// FCR DETECTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

inFCRSession = not na(time(timeframe.period, sessionStart, sessionTimezone))
fcrSessionStart = inFCRSession and not inFCRSession[1]
fcrSessionEnd = not inFCRSession and inFCRSession[1]

var float fcrHigh = na
var float fcrLow = na
var int fcrStartBar = na
var int fcrEndBar = na
var bool fcrEstablished = false

newTradingDay = dayofweek != dayofweek[1]

if newTradingDay
    fcrHigh := na
    fcrLow := na
    fcrEstablished := false

if inFCRSession
    if fcrSessionStart
        fcrHigh := high
        fcrLow := low
        fcrStartBar := bar_index
    else
        fcrHigh := math.max(fcrHigh, high)
        fcrLow := math.min(fcrLow, low)

if fcrSessionEnd
    fcrEndBar := bar_index
    fcrEstablished := true

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// FCR VISUALS
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var line fcrHighLine = na
var line fcrLowLine = na
var box fcrBox = na

if fcrSessionEnd and showFCRBox
    fcrBox := box.new(fcrStartBar, fcrHigh, bar_index, fcrLow, bgcolor=fcrBoxColor, border_color=fcrLineColor, border_width=1)
    label.new(fcrStartBar, fcrHigh, "FCR", style=label.style_label_down, color=color.new(color.blue, 80), textcolor=color.white, size=size.small)

if fcrSessionEnd and showFCRLines
    fcrHighLine := line.new(bar_index, fcrHigh, bar_index + 500, fcrHigh, color=fcrLineColor, style=line.style_solid, width=1)
    fcrLowLine := line.new(bar_index, fcrLow, bar_index + 500, fcrLow, color=fcrLineColor, style=line.style_solid, width=1)

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// BREAKOUT DETECTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var int breakoutDirection = 0
var bool breakoutOccurred = false
var int breakoutBar = na

if fcrEstablished and not breakoutOccurred and not na(fcrHigh) and not na(fcrLow)
    if close > fcrHigh and close[1] <= fcrHigh
        breakoutDirection := 1
        breakoutOccurred := true
        breakoutBar := bar_index
    else if close < fcrLow and close[1] >= fcrLow
        breakoutDirection := -1
        breakoutOccurred := true
        breakoutBar := bar_index

if newTradingDay
    breakoutDirection := 0
    breakoutOccurred := false
    breakoutBar := na

bullishBreakout = breakoutOccurred and breakoutDirection == 1 and bar_index == breakoutBar
bearishBreakout = breakoutOccurred and breakoutDirection == -1 and bar_index == breakoutBar

plotshape(bullishBreakout and showSignals, title="Bullish Breakout", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, text="Break")
plotshape(bearishBreakout and showSignals, title="Bearish Breakout", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, text="Break")

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// FAIR VALUE GAP DETECTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bullishFVG = low > high[2]
bullishFVGTop = low
bullishFVGBottom = high[2]

bearishFVG = high < low[2]
bearishFVGTop = low[2]
bearishFVGBottom = high

var box fvgBox = na
var float fvgTop = na
var float fvgBottom = na
var bool fvgEstablished = false
var int fvgBar = na

if breakoutOccurred and not fvgEstablished and bar_index <= breakoutBar + 20
    if breakoutDirection == 1 and bullishFVG
        fvgTop := bullishFVGTop
        fvgBottom := bullishFVGBottom
        fvgEstablished := true
        fvgBar := bar_index
        if showFVG
            fvgBox := box.new(bar_index - 2, fvgTop, bar_index + 100, fvgBottom, bgcolor=bullFVGColor, border_color=color.gray, border_width=1, text="FVG", text_color=color.white, text_size=size.small)
    
    if breakoutDirection == -1 and bearishFVG
        fvgTop := bearishFVGTop
        fvgBottom := bearishFVGBottom
        fvgEstablished := true
        fvgBar := bar_index
        if showFVG
            fvgBox := box.new(bar_index - 2, fvgTop, bar_index + 100, fvgBottom, bgcolor=bearFVGColor, border_color=color.gray, border_width=1, text="FVG", text_color=color.white, text_size=size.small)

if newTradingDay
    fvgTop := na
    fvgBottom := na
    fvgEstablished := false
    fvgBar := na

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// RETEST DETECTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var bool retestOccurred = false
var float retestExtreme = na
var int retestBar = na

if fvgEstablished and not retestOccurred
    if breakoutDirection == 1 and low <= fvgTop and low >= fvgBottom
        retestOccurred := true
        retestExtreme := low
        retestBar := bar_index
    
    if breakoutDirection == -1 and high >= fvgBottom and high <= fvgTop
        retestOccurred := true
        retestExtreme := high
        retestBar := bar_index

if retestOccurred and bar_index <= retestBar + 10
    if breakoutDirection == 1 and low <= fvgTop and low >= fvgBottom
        retestExtreme := math.min(retestExtreme, low)
    if breakoutDirection == -1 and high >= fvgBottom and high <= fvgTop
        retestExtreme := math.max(retestExtreme, high)

if newTradingDay
    retestOccurred := false
    retestExtreme := na
    retestBar := na

retestSignal = retestOccurred and bar_index == retestBar
plotshape(retestSignal and breakoutDirection == 1 and showSignals, title="Bullish Retest", style=shape.circle, location=location.belowbar, color=color.orange, size=size.tiny, text="Retest")
plotshape(retestSignal and breakoutDirection == -1 and showSignals, title="Bearish Retest", style=shape.circle, location=location.abovebar, color=color.orange, size=size.tiny, text="Retest")

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// ENGULFING CANDLE DETECTION & ENTRY
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bullishEngulfing = close > open and close > open[1] and open <= close[1]
bearishEngulfing = close < open and close < open[1] and open >= close[1]

var bool tradeOpen = false
var bool entryTriggered = false
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na
var int entryBar = na
var int entryDirection = 0

var box tpBox = na
var box slBox = na
var line entryLine = na

if retestOccurred and not entryTriggered and bar_index >= retestBar and bar_index <= retestBar + 15
    if breakoutDirection == 1 and bullishEngulfing
        entryTriggered := true
        tradeOpen := true
        entryPrice := close
        stopLoss := retestExtreme - syminfo.mintick
        takeProfit := entryPrice + (rrRatio * (entryPrice - stopLoss))
        entryBar := bar_index
        entryDirection := 1
        
        // Store in history
        array.push(histDirection, 1)
        array.push(histEntry, entryPrice)
        array.push(histTP, takeProfit)
        array.push(histSL, stopLoss)
        array.push(histResult, "OPEN")
        array.push(histPnL, 0.0)
        array.push(histEntryBar, bar_index)
        array.push(histExitBar, 0)
    
    if breakoutDirection == -1 and bearishEngulfing
        entryTriggered := true
        tradeOpen := true
        entryPrice := close
        stopLoss := retestExtreme + syminfo.mintick
        takeProfit := entryPrice - (rrRatio * (stopLoss - entryPrice))
        entryBar := bar_index
        entryDirection := -1
        
        // Store in history
        array.push(histDirection, -1)
        array.push(histEntry, entryPrice)
        array.push(histTP, takeProfit)
        array.push(histSL, stopLoss)
        array.push(histResult, "OPEN")
        array.push(histPnL, 0.0)
        array.push(histEntryBar, bar_index)
        array.push(histExitBar, 0)

// Draw TP/SL boxes on entry
entrySignal = entryTriggered and bar_index == entryBar

if entrySignal and showPosition
    entryLine := line.new(bar_index, entryPrice, bar_index + 1, entryPrice, color=color.white, style=line.style_dashed, width=1)
    
    if entryDirection == 1
        tpBox := box.new(bar_index, takeProfit, bar_index + 1, entryPrice, bgcolor=color.new(color.green, 85), border_color=color.green, border_width=1)
        slBox := box.new(bar_index, entryPrice, bar_index + 1, stopLoss, bgcolor=color.new(color.red, 85), border_color=color.red, border_width=1)
    else
        tpBox := box.new(bar_index, entryPrice, bar_index + 1, takeProfit, bgcolor=color.new(color.green, 85), border_color=color.green, border_width=1)
        slBox := box.new(bar_index, stopLoss, bar_index + 1, entryPrice, bgcolor=color.new(color.red, 85), border_color=color.red, border_width=1)

plotshape(entrySignal and entryDirection == 1 and showSignals, title="Buy Entry", style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.normal, text="Entry")
plotshape(entrySignal and entryDirection == -1 and showSignals, title="Sell Entry", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, text="Entry")

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// TRADE OUTCOME DETECTION
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var bool tpHit = false
var bool slHit = false
var int exitBar = na
var float exitPrice = na

// Extend boxes while trade is open
if tradeOpen and not na(tpBox) and not na(slBox) and not na(entryLine)
    box.set_right(tpBox, bar_index + 1)
    box.set_right(slBox, bar_index + 1)
    line.set_x2(entryLine, bar_index + 1)

// Check for TP/SL hit
if tradeOpen and not tpHit and not slHit
    if entryDirection == 1
        // Long trade
        if high >= takeProfit
            tpHit := true
            exitBar := bar_index
            exitPrice := takeProfit
            tradeOpen := false
        else if low <= stopLoss
            slHit := true
            exitBar := bar_index
            exitPrice := stopLoss
            tradeOpen := false
    else if entryDirection == -1
        // Short trade
        if low <= takeProfit
            tpHit := true
            exitBar := bar_index
            exitPrice := takeProfit
            tradeOpen := false
        else if high >= stopLoss
            slHit := true
            exitBar := bar_index
            exitPrice := stopLoss
            tradeOpen := false

// Handle trade close - update history and draw exit
if (tpHit or slHit) and bar_index == exitBar
    // Update last history entry
    int lastIdx = array.size(histResult) - 1
    if lastIdx >= 0
        if tpHit
            array.set(histResult, lastIdx, "TP")
            float pnl = entryDirection == 1 ? (takeProfit - entryPrice) : (entryPrice - takeProfit)
            array.set(histPnL, lastIdx, pnl)
        else
            array.set(histResult, lastIdx, "SL")
            float pnl = entryDirection == 1 ? (stopLoss - entryPrice) : (entryPrice - stopLoss)
            array.set(histPnL, lastIdx, pnl)
        array.set(histExitBar, lastIdx, bar_index)
    
    // Trim history to max size
    if array.size(histResult) > MAX_HISTORY
        array.shift(histDirection)
        array.shift(histEntry)
        array.shift(histTP)
        array.shift(histSL)
        array.shift(histResult)
        array.shift(histPnL)
        array.shift(histEntryBar)
        array.shift(histExitBar)

// Draw exit markers
plotshape(tpHit and bar_index == exitBar and showSignals, title="TP Hit", style=shape.xcross, location=location.abovebar, color=color.lime, size=size.small, text="TP ✓")
plotshape(slHit and bar_index == exitBar and entryDirection == 1 and showSignals, title="SL Hit Long", style=shape.xcross, location=location.belowbar, color=color.red, size=size.small, text="SL ✗")
plotshape(slHit and bar_index == exitBar and entryDirection == -1 and showSignals, title="SL Hit Short", style=shape.xcross, location=location.abovebar, color=color.red, size=size.small, text="SL ✗")

// Reset for new day
if newTradingDay
    entryTriggered := false
    tradeOpen := false
    entryPrice := na
    stopLoss := na
    takeProfit := na
    entryBar := na
    entryDirection := 0
    tpHit := false
    slHit := false
    exitBar := na
    exitPrice := na

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// HISTORY TABLE
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

if showHistoryTable
    var table histTable = table.new(position.bottom_left, 6, 13, bgcolor=color.new(color.black, 85), border_color=color.gray, border_width=1, frame_color=color.gray, frame_width=1)
    
    if barstate.islast
        // Header row
        table.cell(histTable, 0, 0, "#", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
        table.cell(histTable, 1, 0, "Dir", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
        table.cell(histTable, 2, 0, "Entry", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
        table.cell(histTable, 3, 0, "Result", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
        table.cell(histTable, 4, 0, "P&L", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
        table.cell(histTable, 5, 0, "Bars", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 50))
        
        // Data rows
        int histSize = array.size(histResult)
        int wins = 0
        int losses = 0
        float totalPnL = 0.0
        
        for i = 0 to math.min(histSize - 1, MAX_HISTORY - 1)
            int idx = histSize - 1 - i  // Reverse order (newest first)
            int row = i + 1
            
            string dir = array.get(histDirection, idx) == 1 ? "▲" : "▼"
            color dirCol = array.get(histDirection, idx) == 1 ? color.green : color.red
            float entry = array.get(histEntry, idx)
            string result = array.get(histResult, idx)
            float pnl = array.get(histPnL, idx)
            int eBar = array.get(histEntryBar, idx)
            int xBar = array.get(histExitBar, idx)
            int barsHeld = xBar > 0 ? xBar - eBar : bar_index - eBar
            
            color resultCol = result == "TP" ? color.lime : result == "SL" ? color.red : color.orange
            color pnlCol = pnl > 0 ? color.lime : pnl < 0 ? color.red : color.gray
            
            if result == "TP"
                wins += 1
            else if result == "SL"
                losses += 1
            totalPnL += pnl
            
            table.cell(histTable, 0, row, str.tostring(i + 1), text_color=color.white, text_size=size.tiny)
            table.cell(histTable, 1, row, dir, text_color=dirCol, text_size=size.tiny)
            table.cell(histTable, 2, row, str.tostring(entry, format.mintick), text_color=color.aqua, text_size=size.tiny)
            table.cell(histTable, 3, row, result, text_color=resultCol, text_size=size.tiny)
            table.cell(histTable, 4, row, (pnl >= 0 ? "+" : "") + str.tostring(pnl * 10000, "#.#") + "p", text_color=pnlCol, text_size=size.tiny)
            table.cell(histTable, 5, row, str.tostring(barsHeld), text_color=color.yellow, text_size=size.tiny)
        
        // Summary row
        int totalTrades = wins + losses
        float winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0
        color winRateCol = winRate >= 50 ? color.lime : color.red
        color totalPnLCol = totalPnL >= 0 ? color.lime : color.red
        
        int summaryRow = math.min(histSize, MAX_HISTORY) + 1
        table.cell(histTable, 0, summaryRow, "TOTAL", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 60))
        table.cell(histTable, 1, summaryRow, str.tostring(wins) + "W", text_color=color.lime, text_size=size.tiny, bgcolor=color.new(color.gray, 60))
        table.cell(histTable, 2, summaryRow, str.tostring(losses) + "L", text_color=color.red, text_size=size.tiny, bgcolor=color.new(color.gray, 60))
        table.cell(histTable, 3, summaryRow, str.tostring(winRate, "#.#") + "%", text_color=winRateCol, text_size=size.tiny, bgcolor=color.new(color.gray, 60))
        table.cell(histTable, 4, summaryRow, (totalPnL >= 0 ? "+" : "") + str.tostring(totalPnL * 10000, "#.#") + "p", text_color=totalPnLCol, text_size=size.tiny, bgcolor=color.new(color.gray, 60))
        table.cell(histTable, 5, summaryRow, "", text_color=color.white, text_size=size.tiny, bgcolor=color.new(color.gray, 60))

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// STATUS TABLE
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_color=color.gray, border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "FCR Status", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, fcrEstablished ? "✓ Established" : "Waiting...", text_color=fcrEstablished ? color.green : color.orange, text_size=size.small)
    
    table.cell(infoTable, 0, 1, "FCR High", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, not na(fcrHigh) ? str.tostring(fcrHigh, format.mintick) : "-", text_color=color.aqua, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "FCR Low", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, not na(fcrLow) ? str.tostring(fcrLow, format.mintick) : "-", text_color=color.aqua, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "Breakout", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, breakoutDirection == 1 ? "▲ Bullish" : breakoutDirection == -1 ? "▼ Bearish" : "None", text_color=breakoutDirection == 1 ? color.green : breakoutDirection == -1 ? color.red : color.gray, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "FVG", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, fvgEstablished ? "✓ Found" : "Waiting...", text_color=fvgEstablished ? color.green : color.orange, text_size=size.small)
    
    string tradeStatus = tradeOpen ? "OPEN" : entryTriggered ? (tpHit ? "TP ✓" : slHit ? "SL ✗" : "Closed") : "No trade"
    color tradeCol = tradeOpen ? color.yellow : tpHit ? color.lime : slHit ? color.red : color.gray
    table.cell(infoTable, 0, 5, "Trade", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, tradeStatus, text_color=tradeCol, text_size=size.small)

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//// ALERTS
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

alertcondition(bullishBreakout, title="Bullish Breakout", message="FCR: Bullish breakout above {{ticker}} FCR high")
alertcondition(bearishBreakout, title="Bearish Breakout", message="FCR: Bearish breakout below {{ticker}} FCR low")
alertcondition(entrySignal and entryDirection == 1, title="Buy Entry", message="FCR: Buy entry signal on {{ticker}}")
alertcondition(entrySignal and entryDirection == -1, title="Sell Entry", message="FCR: Sell entry signal on {{ticker}}")
alertcondition(tpHit and bar_index == exitBar, title="Take Profit Hit", message="FCR: Take profit hit on {{ticker}}")
alertcondition(slHit and bar_index == exitBar, title="Stop Loss Hit", message="FCR: Stop loss hit on {{ticker}}")
